
# 概述

 为了保证事务的[[事务#隔离性|隔离性]]和[[事务#一致性|一致性]]，数据库管理系统需要对并发操作进行正确调度。

# 封锁

事务T在对某个数据对象操作之前，先向系统发出请求，对其加锁。在事务T释放它的锁之前，其他事务不能更新此数据对象 。

## 封锁的两种类型

### 排他锁

又称写锁、X锁，允许事务读取和修改数据对象，其他事物不能对数据对象加任何类型的锁。

### 共享锁

又称读锁、S锁，允许事务读取数据对象但是不能修改，其他事物只能对数据对象加S锁不能加X锁。

# 封锁协议

## 一级封锁协议

事务在修改数据对象之前必须先对其加X锁，直到事务结束才释放。防止丢失修改，并保证事务是可恢复的。

## 二级封锁协议

在一级封锁协议基础上增加事务在读取数据对象之前必须先对其加S锁，读完后即可释放S 锁。防止了丢失修改，还可进一步防止读“脏” 数据。

## 三级封锁协议

在一级封锁协议的基础上增加事务在读取数据对象之前必须先对其加S锁，直到事务结束才释放。防止丢失修改和读“脏” 数据外，还进一步防止了不可重复读。

# 活锁和死锁

封锁的方法可能引起活锁和死锁 等问题。

## 活锁

多事务请求封锁数据对象，先请求事务可能永远等待。避免活锁的简单方法是采用先来先服务的策略。

## 死锁

两个事务或多个事务相互请求封锁对方封锁数据对象。

### 死锁的预防

#### 一次封锁法

每个事务必须一次将所有要使用的数据全部加锁，否则就不能继续执行。

#### 顺序封锁法

预先对数据对象规定一个封锁顺序，所有事务都按这个顺序实施封锁。

### 死锁的诊断与解除

#### 超时法

如果一个事务的等待时间超过了规定的时限，就认为发生了死锁。

#### 等待图法

如果发现[等待图](https://baike.baidu.com/item/%E4%BA%8B%E5%8A%A1%E7%AD%89%E5%BE%85%E5%9B%BE/3851761)中存在回路，则表示系统中出现了死锁。选择一个处理死锁代价最小的事务，将其撤销，释放此事务持有的所有的锁，使其他事务得以继续运行下去。

# 并发调度的可串行性

## 可串行化调度

多个事务的并发执行是正确的，当且仅当其结果与按某一次序串行地执行这些事务时的结果相同。可串行性(serializability)是并发事务正确调度的准则。

## 冲突可串行化调度

### 冲突操作

冲突操作是指不同的事务对同一个数据的读写操作和写写操作。

### 冲突可串行化调度

一个调度Sc在保证冲突操作的次序不变的情况下，通过交换两个事务不冲突操作的次序得到另一个调度Sc‘，如果Sc‘是串行的，称调度Sc为冲突可串行化的调度。


# 两端协议

事务分为两个阶段：
- 第一阶段是获得封锁，也称为扩展阶段。
- 第二阶段是释放封锁，也称为收缩阶段。

# 封锁的粒度

封锁对象的大小称为封锁粒度(granularity)。封锁对象可以是这样一些逻辑单元，也可以是这样一些物理单元，封锁粒度与系统的并发度和并发控制的开销密切相关。

## 多粒度封锁

## 粒度树

多粒度树的根结点是整个数据库，表示最大的数据粒度。叶结点表示最小的数据粒度。

### 多粒度封锁

对一个结点加锁意味着这个结点的所有后裔结点也被加以同样类型的锁。

#### 显式封锁

显式封锁是应事务的要求直接加到数据对象上的锁。

#### 隐式封锁

隐式封锁是该数据对象没有被独立加锁，是由于其上级结点加锁而使该数据对象加上了锁。

## 意向锁

如果对一个结点加意向锁，则说明该结点的下层结点正在被加锁。

### 意向共享锁

意向共享锁(Intent Share Lock,IS锁)后裔结点拟（意向）加S锁。

### 意向排他锁

意向排他锁(IntentExclusive Lock,IX锁)后裔结点拟（意向）加X锁

### 共享意向排他锁

共享意向排他锁(Share Intent Exclusive Lock,SIX锁)表示对它加S锁，再加IX锁，

# 其他并发控制机制

## 时间戳方法

时间戳方法给每一个事务加上一个时间戳，按照这个时间戳来解决事务的冲突操作。

## 乐观控制法

不对事务进行特殊的管制，而是让它自由执行，事务提交前再进行正确性检查。

## 多版本并发控制

通过保存数据在某个时间点的快照来实现并发控制。

### 版本

版本(version)是指数据库中数据对象的一个快照，记录了数据对象某个时刻的状态。

### 优点

多版本并发控制和封锁机制相比，主要的好处是消除了数据库中数据对象读和写操作的冲突，有效地提高了系统的性能。

## 改进的多版本并发控制

区分事务的类型为只读事务和更新事务：

- 只读事务，发生冲突的可能性很小，可以采用多版本时间戳。
- 更新事务，采用较保守的两阶段封锁(2PL)协议。这样的混合协议称为MV2PL。除了传统的读锁（共享锁）和写锁（排他锁）外，引进一个新的封锁类型，称为验证锁(certify-lock，或C锁)。